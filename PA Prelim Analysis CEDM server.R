#############################################
# Start analysis only looking at PA CEMS data
#############################################

# Install packages
install.packages("lubridate")
install.packages("sp")
install.packages("raster")
install.packages("rasterVis")
install.packages("maptools")
install.packages("rgeos")
install.packages("rgdal")
install.packages("ggmap")
install.packages("readxl")
install.packages("dplyr")
install.packages("chron")
install.packages("FinCal")
install.packages("xlsx")
install.packages("grid")
install.packages("ggplot2")
install.packages("plyr")
install.packages("scales")
install.packages("rworldmap")
install.packages("data.table")
install.packages("httr")
install.packages("XML")
install.packages("reshape2")
install.packages("ggthemes")

library(lubridate)
library(sp)  # classes for spatial data
library(raster)  # grids, rasters
library(rasterVis)  # raster visualisation
library(maptools)
library(rgeos)
library(rgdal)
library(ggmap)
library(readxl)
library(dplyr)
library(chron)
library(FinCal)
library(xlsx)
library(grid)
library(ggplot2)
library(plyr)
library(scales)
library(ggthemes)
library(rworldmap)
library(data.table)
library(httr)
library(XML)
library(reshape2)

# Set working directory
setwd("C:/Users/nhanus/Documents/Marginal-Plant-Analysis")


# Read in data
pa01_2016 <- read.csv(file = "C:/Users/nhanus/Documents/Marginal-Plant-Analysis/2016pa01.csv", header = TRUE, sep = ",", stringsAsFactors=FALSE)
pa02_2016 <- read.csv(file = "C:/Users/nhanus/Documents/Marginal-Plant-Analysis/2016pa02.csv", header = TRUE, sep = ",", stringsAsFactors=FALSE)
pa03_2016 <- read.csv(file = "C:/Users/nhanus/Documents/Marginal-Plant-Analysis/2016pa03.csv", header = TRUE, sep = ",", stringsAsFactors=FALSE)
pa04_2016 <- read.csv(file = "C:/Users/nhanus/Documents/Marginal-Plant-Analysis/2016pa04.csv", header = TRUE, sep = ",", stringsAsFactors=FALSE)
pa05_2016 <- read.csv(file = "C:/Users/nhanus/Documents/Marginal-Plant-Analysis/2016pa05.csv", header = TRUE, sep = ",", stringsAsFactors=FALSE)
pa06_2016 <- read.csv(file = "C:/Users/nhanus/Documents/Marginal-Plant-Analysis/2016pa06.csv", header = TRUE, sep = ",", stringsAsFactors=FALSE)
pa07_2016 <- read.csv(file = "C:/Users/nhanus/Documents/Marginal-Plant-Analysis/2016pa07.csv", header = TRUE, sep = ",", stringsAsFactors=FALSE)
pa08_2016 <- read.csv(file = "C:/Users/nhanus/Documents/Marginal-Plant-Analysis/2016pa08.csv", header = TRUE, sep = ",", stringsAsFactors=FALSE)
pa09_2016 <- read.csv(file = "C:/Users/nhanus/Documents/Marginal-Plant-Analysis/2016pa09.csv", header = TRUE, sep = ",", stringsAsFactors=FALSE)
pa10_2016 <- read.csv(file = "C:/Users/nhanus/Documents/Marginal-Plant-Analysis/2016pa10.csv", header = TRUE, sep = ",", stringsAsFactors=FALSE)
pa11_2016 <- read.csv(file = "C:/Users/nhanus/Documents/Marginal-Plant-Analysis/2016pa11.csv", header = TRUE, sep = ",", stringsAsFactors=FALSE)
pa12_2016 <- read.csv(file = "C:/Users/nhanus/Documents/Marginal-Plant-Analysis/2016pa12.csv", header = TRUE, sep = ",", stringsAsFactors=FALSE)


# Combine PA datasets 1-10
pa_2016 <- rbind(pa01_2016, pa02_2016, pa03_2016, pa04_2016, pa05_2016, pa06_2016, pa07_2016, pa08_2016, pa09_2016, pa10_2016, pa11_2016, pa12_2016)

###########################
# Some key data definitions
###########################

# GLOAD (MW) = Gross load. Rate of electrical generation of a unit or source produced by combusting a given heat input of fuel.
# SLOAD (1000lb/hr) = Steam load. Rate of steam pressure generated by a unit or source produced by combusting a given heat input of fuel.
# OP_DATE = Day on which activity occurred.
# OP_HOUR = Hour in which acitvity occurred.
# OP_TIME = Any part of an hour in which a unit combusts any fuel.
# FACILITY_NAME = The name given by the owners and operators to a facility.
# ORISPL_CODE = The unique six-digit facility identification number, also called an ORISPL, assigned by the Energy Information Administration.
# UNITID = Unique identifier for each unit at a facility.
# FAC_ID = Unsure
# UNIT_ID = Unsure


# Check the class of every variable
class(pa_2016$STATE) # character
class(pa_2016$FACILITY_NAME) # character
class(pa_2016$ORISPL_CODE) # integer
class(pa_2016$UNITID) # character
class(pa_2016$OP_DATE) # character
class(pa_2016$OP_HOUR) # integer
class(pa_2016$OP_TIME) # numeric
class(pa_2016$GLOAD..MW.) # integer
class(pa_2016$SLOAD..1000lb.hr.) # integer
class(pa_2016$SO2_MASS..lbs.) # numeric
class(pa_2016$SO2_MASS_MEASURE_FLG) # character
class(pa_2016$SO2_RATE..lbs.mmBtu.) # numeric
class(pa_2016$SO2_RATE_MEASURE_FLG) # character
class(pa_2016$NOX_MASS..lbs.) # numeric
class(pa_2016$NOX_MASS_MEASURE_FLG) # character
class(pa_2016$NOX_RATE..lbs.mmBtu.) # numeric
class(pa_2016$NOX_RATE_MEASURE_FLG) # character
class(pa_2016$CO2_MASS..tons.) # numeric
class(pa_2016$CO2_MASS_MEASURE_FLG) # character
class(pa_2016$CO2_RATE..tons.mmBtu.) # numeric
class(pa_2016$CO2_RATE_MEASURE_FLG) # character
class(pa_2016$HEAT_INPUT..mmBtu.) # numeric
class(pa_2016$FAC_ID) # integer
class(pa_2016$UNIT_ID) # integer

# Change date - break into month, day and year
pa_2016$month <- as.numeric(substr(pa_2016$OP_DATE, 1, 2))
pa_2016$day   <- as.numeric(substr(pa_2016$OP_DATE, 4, 5))
pa_2016$year  <- as.numeric(substr(pa_2016$OP_DATE, 7, 10))

# Change some integers to numeric
pa_2016$OP_HOUR             <- as.numeric(pa_2016$OP_HOUR)
pa_2016$GLOAD..MW.          <- as.numeric(pa_2016$GLOAD..MW.)
pa_2016$SLOAD..1000lb.hr.   <- as.numeric(pa_2016$SLOAD..1000lb.hr.)

# Check the class of transformed variables
class(pa_2016$month) # numeric
class(pa_2016$day) # numeric
class(pa_2016$year) # numeric
class(pa_2016$OP_HOUR) # numeric
class(pa_2016$GLOAD..MW.) # numeric
class(pa_2016$SLOAD..1000lb.hr.) # numeric

# Count total observations for PA - across all plants and timestamps
nrow(pa_2016) # 1,477,992

# Unique facility names
nrow(pa_2016[!duplicated(pa_2016$FACILITY_NAME),]) # 74

# Unique ORISPL_codes
nrow(pa_2016[!duplicated(pa_2016$ORISPL_CODE),]) # 74

# Unique UNITIDs
nrow(pa_2016[!duplicated(pa_2016$UNITID),]) # 97

# Unique facility IDs
nrow(pa_2016[!duplicated(pa_2016$FAC_ID),]) # 74 - just giong to use ORISPL_Codes since we don't know what fac_id is

# Unique UNIT_IDs
nrow(pa_2016[!duplicated(pa_2016$UNIT_ID),]) # 177 - just going to use UNITIDs since we don't know what UNIT_ID is

# Consider one facility: ORISPL_CODE = 3096
nrow(pa_2016[which(pa_2016$ORISPL_CODE == 3096),]) # 26352 observations or 1.7% of all observations

# Count total non-NA GLOAD observations - across all plants and timestamps
nrow(pa_2016[!is.na(pa_2016$GLOAD..MW.),]) # 443,409 or 30%

# Count total non-NA CO2 emissions obervations - across all plants and timestamps
nrow(pa_2016[!is.na(pa_2016$CO2_MASS..tons.),]) # 493643 or 33%

# Count times that GLOAD is NA and CO2 emissions is non-NA
nrow(pa_2016[which(is.na(pa_2016$GLOAD..MW.) & !is.na(pa_2016$CO2_MASS..tons.)),]) # 77,872 or 5% of data

# Count times that GLOAD is non-NA and CO2 emissions is NA
nrow(pa_2016[which(!is.na(pa_2016$GLOAD..MW.) & is.na(pa_2016$CO2_MASS..tons.)),]) # 27,638 or 2% of data

# Look at total distribution of GLOAD
hist(pa_2016$GLOAD..MW.) # fairly normal

# Look at total distribution of CO2 emisisons
hist(pa_2016$CO2_MASS..tons.) # right skew


################
# Data cleaning
################

# First, check the number of instances meeting the three points highlighted in the CEMS Documentation by Priya

#######################################################################################################################
# 1. Unit has positive gross generation and positive heat input,
# but zero emissions for any pollutant in the given hour (i.e. the unit is "on" but reported as producing no emissions)
#######################################################################################################################

# First check that there is never a negative value for gross generation and heat input
summary(pa_2016$GLOAD..MW.) # min = 0
summary(pa_2016$HEAT_INPUT..mmBtu.) # min = 0

nrow(pa_2016[which((pa_2016$GLOAD..MW. > 0 & pa_2016$HEAT_INPUT..mmBtu. > 0) & (pa_2016$CO2_MASS..tons. == 0 | pa_2016$SO2_MASS..lbs. == 0 | pa_2016$NOX_MASS..lbs. == 0)),]) # 1,531 or .1%
nrow(pa_2016[which((pa_2016$GLOAD..MW. > 0 & pa_2016$HEAT_INPUT..mmBtu. > 0) & pa_2016$CO2_MASS..tons. == 0),]) # 89 or 0.006%
nrow(pa_2016[which((pa_2016$GLOAD..MW. > 0 & pa_2016$HEAT_INPUT..mmBtu. > 0) & pa_2016$SO2_MASS..lbs. == 0),]) # 1,365 or 0.09%
nrow(pa_2016[which((pa_2016$GLOAD..MW. > 0 & pa_2016$HEAT_INPUT..mmBtu. > 0) & pa_2016$NOX_MASS..lbs. == 0),]) # 230

# CLEAN CRITERIA? zero OR MISSING
nrow(pa_2016[which((pa_2016$GLOAD..MW. > 0 & pa_2016$HEAT_INPUT..mmBtu. > 0) & (is.na(pa_2016$CO2_MASS..tons.) | is.na(pa_2016$SO2_MASS..lbs.) | is.na(pa_2016$NOX_MASS..lbs.))),]) # 27,450 or 2%
nrow(pa_2016[which((pa_2016$GLOAD..MW. > 0 & pa_2016$HEAT_INPUT..mmBtu. > 0) & is.na(pa_2016$CO2_MASS..tons.)),]) # 27,450 or 2%
nrow(pa_2016[which((pa_2016$GLOAD..MW. > 0 & pa_2016$HEAT_INPUT..mmBtu. > 0) & is.na(pa_2016$SO2_MASS..lbs.)),]) # 19,763 or 1%
nrow(pa_2016[which((pa_2016$GLOAD..MW. > 0 & pa_2016$HEAT_INPUT..mmBtu. > 0) & is.na(pa_2016$NOX_MASS..lbs.)),]) # 0

# CLEAN CRITERIA? What about if just one of the "generation" criteria are met? (i.e. OR)
nrow(pa_2016[which(pa_2016$GLOAD..MW. > 0 & (is.na(pa_2016$CO2_MASS..tons.) | is.na(pa_2016$SO2_MASS..lbs.) | is.na(pa_2016$NOX_MASS..lbs.))),]) # 27,450 or 2%
nrow(pa_2016[which(pa_2016$HEAT_INPUT..mmBtu. > 0 & (is.na(pa_2016$CO2_MASS..tons.) | is.na(pa_2016$SO2_MASS..lbs.) | is.na(pa_2016$NOX_MASS..lbs.))),]) # 194,383 or 13%

# CLEAN CRITERIA? Unit has positive gross generation and non-positive heat input; unit has non-positive gross generation and positive heat input
nrow(pa_2016[which(pa_2016$GLOAD..MW. > 0 & (is.na(pa_2016$HEAT_INPUT..mmBtu. | pa_2016$HEAT_INPUT..mmBtu. == 0))),]) # 0
nrow(pa_2016[which((is.na(pa_2016$GLOAD..MW.) | pa_2016$GLOAD..MW. == 0) & pa_2016$HEAT_INPUT..mmBtu. > 0),]) # 249,276 or 17% of dataset

###########################################################################################
# 2. The unit has positive gross generation and positive heat input,
# but reports less than 300 kg CO2/mWH (i.e. has unreasonably low carbon dioxide intensity)
###########################################################################################

# create a column of "carbon dioxide intensity"
pa_2016$carbonintensity <- pa_2016$CO2_MASS..tons. * 907.185 / pa_2016$GLOAD..MW. # kg/MWh

nrow(pa_2016[which(pa_2016$GLOAD..MW. > 0 & pa_2016$HEAT_INPUT..mmBtu. > 0 & pa_2016$carbonintensity < 300),]) # 4,075 or .2%

# CLEAN CRITERIA?: What about if just one of the "generation" criteria are met?
nrow(pa_2016[which(pa_2016$GLOAD..MW. > 0 & pa_2016$carbonintensity < 300),]) # 4,075 or .2%
nrow(pa_2016[which(pa_2016$HEAT_INPUT..mmBtu. > 0 & pa_2016$carbonintensity < 300),]) # 4,075 or .2%

###################################################################################################################
# 3. The unit has zero (or missing) gross generation or heat input,
# but non-zero emissions for any pollutant (i.e. the unit is producing emissions but is not reported as being "on")
###################################################################################################################

# Check to make sure the emissions are all non-negative
summary(pa_2016$CO2_MASS..tons.) # min = 0
summary(pa_2016$SO2_MASS..lbs.) # min = 0
summary(pa_2016$NOX_MASS..lbs.) # min = 0
nrow(pa_2016[which(pa_2016$GLOAD..MW. <= 0),]) # 4915
nrow(pa_2016[which(pa_2016$GLOAD..MW. == 0),]) # 4915
nrow(pa_2016[is.na(pa_2016$GLOAD..MW.),]) # 1,034,583 or 70%

nrow(pa_2016[which((pa_2016$GLOAD..MW. <= 0 | is.na(pa_2016$GLOAD..MW.) | pa_2016$HEAT_INPUT..mmBtu. <= 0 | is.na(pa_2016$HEAT_INPUT..mmBtu.)) & (pa_2016$CO2_MASS..tons. > 0 | pa_2016$SO2_MASS..lbs. > 0 | pa_2016$NOX_MASS..lbs. > 0)),]) # 247,605 or 17%


##############################################################################################################################
# Cut the data
# Use the 3 criteria outlined by Priya, update as such:
# Criteria 1: The unit has positive gross generation and positive heat input but zero (or missing) emissions for any pollutant
# Criteria 2: The unit has positive gross generation and positive heat input, but reports less than 300 kg CO2/MWh
# Criteria 3: The unit has zero (or missing) gross generation or heat input, but positive emissions for any pollutant

# Note: I am not including the gross generation & heat input criteria until after the 3/2/18 meeting
##############################################################################################################################

# Criteria 1
pa_2016_clean <- pa_2016[-which((pa_2016$GLOAD..MW. > 0 & pa_2016$HEAT_INPUT..mmBtu. > 0) & (pa_2016$CO2_MASS..tons. == 0 | pa_2016$SO2_MASS..lbs. == 0 | pa_2016$NOX_MASS..lbs. == 0)),]
pa_2016_clean <- pa_2016_clean[-which((pa_2016_clean$GLOAD..MW. > 0 & pa_2016_clean$HEAT_INPUT..mmBtu. > 0) & (is.na(pa_2016_clean$CO2_MASS..tons.) | is.na(pa_2016_clean$SO2_MASS..lbs.) | is.na(pa_2016_clean$NOX_MASS..lbs.))),]

# Criteria 2
pa_2016_clean <- pa_2016_clean[-which(pa_2016_clean$GLOAD..MW. > 0 & pa_2016_clean$HEAT_INPUT..mmBtu. > 0 & pa_2016_clean$carbonintensity < 300),]

# Criteria 3
pa_2016_clean <- pa_2016_clean[-which((pa_2016_clean$GLOAD..MW. <= 0 | is.na(pa_2016_clean$GLOAD..MW.) | pa_2016_clean$HEAT_INPUT..mmBtu. <= 0 | is.na(pa_2016_clean$HEAT_INPUT..mmBtu.)) & (pa_2016_clean$CO2_MASS..tons. > 0 | pa_2016_clean$SO2_MASS..lbs. > 0 | pa_2016_clean$NOX_MASS..lbs. > 0)),]

# Check difference in dataframe sizes before and after cleaning
nrow(pa_2016) # 1,477,992
nrow(pa_2016_clean) # 1,197,871; lose 19%


##################################################################################
# Continue next set of analyses just looking at a single unit; ORISPL_CODE = 3096
##################################################################################

# What is the name of the facility for unit with ORISPL_CODE = 3096
count(pa_2016_clean[which(pa_2016_clean$ORISPL_CODE == 3096),]$FACILITY_NAME) # Facility name is "Brunot Island Power Station"; 26,201 observations of this unit
nrow(pa_2016_clean[which(pa_2016_clean$ORISPL_CODE == 3096),]) # 26,201 observations 
count(pa_2016_clean[which(pa_2016_clean$FACILITY_NAME == "Brunot Island Power Station"),]$UNITID) # 2A, 2B, and 3

# Just make a dataframe of ORISPL_CODE = 3096 and UNITID == 33
ORISPL_3096_3 <- pa_2016_clean[which(pa_2016_clean$ORISPL_CODE == 3096 & pa_2016_clean$UNITID == 3),]
nrow(ORISPL_3096_3) # 8,733

# CLEAN CRITERIA?: Should each unit be checked to make sure we have 8760 observations?

# Distribution of total year (2016) generation
hist(ORISPL_3096_3$GLOAD..MW.)

# Count all positive generation observations
nrow(ORISPL_3096_3[which(ORISPL_3096_3$GLOAD..MW. > 0),]) # 373 or 4%

# look at generation across time
# make a "time" hr-unit identifier
timeunit <- seq(1,8733,1)
ORISPL_3096_3$timeunit <- timeunit

plot(x = ORISPL_3096_3$timeunit, y = ORISPL_3096_3$GLOAD..MW.)

# Check out date of timeunit ~ 6,000
ORISPL_3096_3[which(ORISPL_3096_3$timeunit == 6000),]$month # 9

# Look at a single day
summary(ORISPL_3096_3[which(ORISPL_3096_3$month == 9),]$GLOAD..MW.) # min = 1, max = 72
count(ORISPL_3096_3[which(ORISPL_3096_3$month == 9 & ORISPL_3096_3$GLOAD..MW. > 0),]$day) # 8, 9, 18, 19, 20, 21, 22, 23

summary(ORISPL_3096_3[which(ORISPL_3096_3$month == 9 & ORISPL_3096_3$day == 8),]$GLOAD..MW.) # min = 8, max = 63

# Notice that a single hour might have multiple entries if the unit changes load within it
plot(x = ORISPL_3096_3[which(ORISPL_3096_3$month == 9 & ORISPL_3096_3$day == 8),]$OP_HOUR, 
     y = ORISPL_3096_3[which(ORISPL_3096_3$month == 9 & ORISPL_3096_3$day == 8),]$GLOAD..MW.)

# What is max time unit?
View(ORISPL_3096_3[which(ORISPL_3096_3$timeunit == max(ORISPL_3096_3$timeunit)),])

# What is min time unit?
View(ORISPL_3096_3[which(ORISPL_3096_3$timeunit == min(ORISPL_3096_3$timeunit)),])







